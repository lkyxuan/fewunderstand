name: Auto PR + Deploy Preview

on:
  push:
    branches:
      # åŠŸèƒ½å¼€å‘
      - 'feature/**'
      - 'feature_*'
      # Bug ä¿®å¤
      - 'bugfix/**'
      - 'bugfix_*'
      # ç´§æ€¥ä¿®å¤ï¼ˆç›´æ¥åˆ° mainï¼‰
      - 'hotfix/**'
      - 'hotfix_*'
      # æ—¥å¸¸ç»´æŠ¤
      - 'chore/**'
      - 'chore_*'
      # ä»£ç é‡æ„
      - 'refactor/**'
      - 'refactor_*'
      # æ–‡æ¡£
      - 'docs/**'
      - 'docs_*'
      # ç¼–å·åˆ†æ”¯ï¼ˆå¦‚ 001-infrastructureï¼‰
      - '[0-9][0-9][0-9]-*'
      # ç”¨æˆ·ä¸ªäººåˆ†æ”¯
      - 'lkyxuan/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  # ==================== Job 1: åˆ›å»º PR ====================
  create-pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_url: ${{ steps.pr.outputs.pr_url }}
      is_new_pr: ${{ steps.pr.outputs.is_new_pr }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create or Get PR
        id: pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ PR
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "PR already exists: #$PR_NUMBER"
            PR_URL=$(gh pr view $PR_NUMBER --json url --jq '.url')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "is_new_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ ¹æ®åˆ†æ”¯ç±»å‹ç¡®å®š base åˆ†æ”¯å’Œ PR æ ‡é¢˜å‰ç¼€
          if [[ "$BRANCH_NAME" == hotfix_* || "$BRANCH_NAME" == hotfix/* ]]; then
            BASE_BRANCH="main"
            PR_PREFIX="Hotfix"
          elif [[ "$BRANCH_NAME" == feature_* || "$BRANCH_NAME" == feature/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Feature"
          elif [[ "$BRANCH_NAME" == bugfix_* || "$BRANCH_NAME" == bugfix/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Bugfix"
          elif [[ "$BRANCH_NAME" == chore_* || "$BRANCH_NAME" == chore/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Chore"
          elif [[ "$BRANCH_NAME" == refactor_* || "$BRANCH_NAME" == refactor/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Refactor"
          elif [[ "$BRANCH_NAME" == docs_* || "$BRANCH_NAME" == docs/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Docs"
          elif [[ "$BRANCH_NAME" =~ ^[0-9]{3}- ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Feature"
          else
            BASE_BRANCH="dev"
            PR_PREFIX="Update"
          fi

          # æå–åˆ†æ”¯åç§°ä¸­çš„æè¿°éƒ¨åˆ†å¹¶è½¬ä¸ºæ ‡é¢˜æ ¼å¼
          BRANCH_DESC=$(echo "$BRANCH_NAME" | sed 's|^[^_/]*[_/]||; s|^[0-9]*-||' | tr '-' ' ' | tr '_' ' ')
          BRANCH_DESC=$(echo "$BRANCH_DESC" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          # åˆ›å»º PR
          cat > /tmp/pr_body.md << 'EOF'
          Auto-generated PR for branch $BRANCH_NAME

          **Target:** $BASE_BRANCH

          ---

          ## Checklist
          - [ ] Tests pass
          - [ ] Documentation updated (if needed)
          - [ ] Code follows project style

          ---
          ğŸ¤– æµ‹è¯•ç½‘éƒ¨ç½²çŠ¶æ€å°†åœ¨ä¸‹æ–¹è¯„è®ºä¸­æ›´æ–°
          EOF

          PR_URL=$(gh pr create \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "$PR_PREFIX: $BRANCH_DESC" \
            --body "Auto-generated PR for branch $BRANCH_NAME

          **Target:** $BASE_BRANCH

          ---

          ## Checklist
          - [ ] Tests pass
          - [ ] Documentation updated (if needed)
          - [ ] Code follows project style

          ---
          ğŸ¤– æµ‹è¯•ç½‘éƒ¨ç½²çŠ¶æ€å°†åœ¨ä¸‹æ–¹è¯„è®ºä¸­æ›´æ–°" \
            --json url --jq '.url' || echo "")

          if [ -n "$PR_URL" ]; then
            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            echo "PR created: $PR_URL"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "is_new_pr=true" >> $GITHUB_OUTPUT
          else
            echo "Failed to create PR"
            exit 1
          fi

  # ==================== Job 2: AI éƒ¨ç½²æµ‹è¯•ç½‘ ====================
  deploy-preview:
    needs: create-pr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze changes
        id: analyze
        run: |
          # åˆ†æè¿™æ¬¡å˜æ›´æ¶‰åŠå“ªäº›æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only origin/dev..HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # åˆ¤æ–­æ˜¯å¦éœ€è¦éƒ¨ç½²
          NEED_DEPLOY="true"
          DEPLOY_REASON=""

          # åªæœ‰æ–‡æ¡£å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²
          if echo "$CHANGED_FILES" | grep -qvE '\.(md|txt|rst)$'; then
            DEPLOY_REASON="ä»£ç å˜æ›´ï¼Œéœ€è¦éƒ¨ç½²"
          else
            if [ -n "$CHANGED_FILES" ]; then
              NEED_DEPLOY="false"
              DEPLOY_REASON="ä»…æ–‡æ¡£å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"
            else
              NEED_DEPLOY="false"
              DEPLOY_REASON="æ— æ–‡ä»¶å˜æ›´"
            fi
          fi

          echo "need_deploy=$NEED_DEPLOY" >> $GITHUB_OUTPUT
          echo "deploy_reason=$DEPLOY_REASON" >> $GITHUB_OUTPUT
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup SSH
        if: steps.analyze.outputs.need_deploy == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 46.224.5.136 >> ~/.ssh/known_hosts

      - name: AI Deploy to Test Server
        if: steps.analyze.outputs.need_deploy == 'true'
        id: deploy
        run: |
          # å°†å˜æ›´æ–‡ä»¶åˆ—è¡¨å’Œåˆ†æ”¯ä¿¡æ¯ä¼ é€’ç»™æœåŠ¡å™¨ä¸Šçš„ AI
          BRANCH_NAME="${{ github.ref_name }}"
          CHANGED_FILES="${{ steps.analyze.outputs.changed_files }}"

          # SSH åˆ°æœåŠ¡å™¨æ‰§è¡Œ AI éƒ¨ç½²
          ssh root@46.224.5.136 << ENDSSH
            set -e
            cd /root/fuce

            echo "========== æ‹‰å–ä»£ç  =========="
            git fetch origin $BRANCH_NAME
            git checkout $BRANCH_NAME
            git pull origin $BRANCH_NAME

            echo "========== AI åˆ†æå¹¶éƒ¨ç½² =========="
            # è°ƒç”¨ Claude Code è¿›è¡Œæ™ºèƒ½éƒ¨ç½²
            claude --print "
            ä½ æ˜¯éƒ¨ç½²åŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹ä»£ç å˜æ›´å¹¶æ‰§è¡Œéƒ¨ç½²ï¼š

            åˆ†æ”¯ï¼š$BRANCH_NAME
            å˜æ›´æ–‡ä»¶ï¼š
            $CHANGED_FILES

            è¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
            1. åˆ†æå˜æ›´æ–‡ä»¶ï¼Œåˆ¤æ–­éœ€è¦å“ªäº›éƒ¨ç½²æ“ä½œï¼š
               - å‰ç«¯ä»£ç  (frontend/) â†’ npm build + é‡å¯å‰ç«¯æœåŠ¡
               - çˆ¬è™«ä»£ç  (crawlers/) â†’ é‡å¯çˆ¬è™«å®¹å™¨
               - docker-compose.yml â†’ docker compose up -d
               - æ•°æ®åº“ç›¸å…³ â†’ è¿è¡Œè¿ç§»è„šæœ¬
               - Hasura metadata â†’ hasura metadata apply
               - ä»…é…ç½®æ–‡ä»¶ â†’ å¯èƒ½åªéœ€é‡å¯æœåŠ¡

            2. æ‰§è¡Œå¿…è¦çš„éƒ¨ç½²å‘½ä»¤

            3. éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š
               - æ£€æŸ¥å®¹å™¨çŠ¶æ€ï¼šdocker compose ps
               - æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
               - ç®€å•çš„å¥åº·æ£€æŸ¥

            4. æœ€åè¾“å‡ºéƒ¨ç½²ç»“æœï¼Œæ ¼å¼ï¼š
               DEPLOY_STATUS: SUCCESS æˆ– FAILED
               DEPLOY_SUMMARY: ä¸€å¥è¯æ€»ç»“
               DEPLOY_DETAILS: è¯¦ç»†æ“ä½œæ—¥å¿—
            "
          ENDSSH

          echo "deploy_success=true" >> $GITHUB_OUTPUT

      - name: Comment Success on PR
        if: steps.analyze.outputs.need_deploy == 'true' && steps.deploy.outputs.deploy_success == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ needs.create-pr.outputs.pr_number }} --body "## ğŸ¤– æµ‹è¯•ç½‘éƒ¨ç½²ç»“æœ

          âœ… **éƒ¨ç½²æˆåŠŸ**

          | é¡¹ç›® | ä¿¡æ¯ |
          |------|------|
          | åˆ†æ”¯ | \`${{ github.ref_name }}\` |
          | Commit | \`${{ github.sha }}\` |
          | æµ‹è¯•åœ°å€ | http://46.224.5.136:18080 |

          ---
          è¯·éªŒè¯åŠŸèƒ½å Merge æ­¤ PRã€‚"

      - name: Comment Skip on PR
        if: steps.analyze.outputs.need_deploy == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ needs.create-pr.outputs.pr_number }} --body "## ğŸ¤– æµ‹è¯•ç½‘éƒ¨ç½²ç»“æœ

          â­ï¸ **è·³è¿‡éƒ¨ç½²**

          åŸå› ï¼š${{ steps.analyze.outputs.deploy_reason }}

          ---
          æ­¤ PR ä¸æ¶‰åŠéœ€è¦éƒ¨ç½²çš„ä»£ç å˜æ›´ã€‚"

      - name: Comment Failure on PR
        if: failure() && steps.analyze.outputs.need_deploy == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ needs.create-pr.outputs.pr_number }} --body "## ğŸ¤– æµ‹è¯•ç½‘éƒ¨ç½²ç»“æœ

          âŒ **éƒ¨ç½²å¤±è´¥**

          | é¡¹ç›® | ä¿¡æ¯ |
          |------|------|
          | åˆ†æ”¯ | \`${{ github.ref_name }}\` |
          | Commit | \`${{ github.sha }}\` |

          è¯·æ£€æŸ¥ [Action æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) æŸ¥çœ‹è¯¦ç»†é”™è¯¯ã€‚"
