name: Auto Create PR

on:
  push:
    branches:
      # åŠŸèƒ½å¼€å‘
      - 'feature/**'
      - 'feature_*'
      # Bug ä¿®å¤
      - 'bugfix/**'
      - 'bugfix_*'
      # ç´§æ€¥ä¿®å¤ï¼ˆç›´æ¥åˆ° mainï¼‰
      - 'hotfix/**'
      - 'hotfix_*'
      # æ—¥å¸¸ç»´æŠ¤
      - 'chore/**'
      - 'chore_*'
      # ä»£ç é‡æ„
      - 'refactor/**'
      - 'refactor_*'
      # æ–‡æ¡£
      - 'docs/**'
      - 'docs_*'
      # ç¼–å·åˆ†æ”¯ï¼ˆå¦‚ 001-infrastructureï¼‰
      - '[0-9][0-9][0-9]-*'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ PR
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')

          if [ -n "$PR_EXISTS" ]; then
            echo "PR already exists: #$PR_EXISTS. Skipping creation."
            exit 0
          fi

          # æ ¹æ®åˆ†æ”¯ç±»å‹ç¡®å®š base åˆ†æ”¯å’Œ PR æ ‡é¢˜å‰ç¼€
          if [[ "$BRANCH_NAME" == hotfix_* || "$BRANCH_NAME" == hotfix/* ]]; then
            BASE_BRANCH="main"
            PR_PREFIX="Hotfix"
          elif [[ "$BRANCH_NAME" == feature_* || "$BRANCH_NAME" == feature/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Feature"
          elif [[ "$BRANCH_NAME" == bugfix_* || "$BRANCH_NAME" == bugfix/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Bugfix"
          elif [[ "$BRANCH_NAME" == chore_* || "$BRANCH_NAME" == chore/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Chore"
          elif [[ "$BRANCH_NAME" == refactor_* || "$BRANCH_NAME" == refactor/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Refactor"
          elif [[ "$BRANCH_NAME" == docs_* || "$BRANCH_NAME" == docs/* ]]; then
            BASE_BRANCH="dev"
            PR_PREFIX="Docs"
          elif [[ "$BRANCH_NAME" =~ ^[0-9]{3}- ]]; then
            # ç¼–å·åˆ†æ”¯ï¼ˆå¦‚ 001-infrastructureï¼‰
            BASE_BRANCH="dev"
            PR_PREFIX="Feature"
          else
            BASE_BRANCH="dev"
            PR_PREFIX="Update"
          fi

          # æå–åˆ†æ”¯åç§°ä¸­çš„æè¿°éƒ¨åˆ†å¹¶è½¬ä¸ºæ ‡é¢˜æ ¼å¼
          BRANCH_DESC=$(echo "$BRANCH_NAME" | sed 's|^[^_/]*[_/]||; s|^[0-9]*-||' | tr '-' ' ' | tr '_' ' ')
          # é¦–å­—æ¯å¤§å†™ (å…¼å®¹ GNU/BSD sed)
          BRANCH_DESC=$(echo "$BRANCH_DESC" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

          # åˆ›å»º PR
          BODY="ğŸ¤– Auto-generated PR for branch \`$BRANCH_NAME\`

          Target: \`$BASE_BRANCH\`

          ---

          ## Checklist

          - [ ] Tests pass
          - [ ] Documentation updated (if needed)
          - [ ] Code follows project style"

          gh pr create \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "$PR_PREFIX: $BRANCH_DESC" \
            --body "$BODY" \
            || echo "Failed to create PR"

          echo "PR created successfully!"
